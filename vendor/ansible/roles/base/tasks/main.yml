---
# This role contains tasks for install base packages

- name: upgrade system (debian)
  apt:
    update_cache: true
    name: '*'
    state: latest
  when: ansible_os_family == "Debian"
- name: upgrade system (redhat)
  yum:
    update_cache: true
    name: '*'
    state: latest
  when: ansible_os_family == "RedHat"
- name: install base packages (debian)
  apt:
    name: "{{ item }}"
  with_items:
    - unzip
    - vim-nox
    - curl
    - python-software-properties
    - git 
    - mercurial
    - build-essential
    - perl
    - librbd-dev
    - lshw
    - python-pip
  when: ansible_os_family == "Debian"
- name: install base packages (redhat)
  yum:
    name: "{{ item }}"
  with_items:
    - epel-release
    - ntp
    - unzip
    - vim
    - curl
    - git
    - mercurial
    - openvswitch
    - gcc
    - perl
    - librbd1-devel
    - lshw
    - python-pip
    - python-requests # XXX required by ceph repo, but it has a bad package on it
  when: ansible_os_family == "RedHat"
- name: install and start ntp
  shell: systemctl enable ntpd
  when: ansible_os_family == "RedHat"
- name: download consul binary 
  get_url: 
    validate_certs: no
    url: https://dl.bintray.com/mitchellh/consul/0.5.2_linux_amd64.zip
    dest: /tmp/consul.zip
- name: install consul
  shell: "chdir=/tmp creates=/usr/bin/consul unzip /tmp/consul.zip && mv /tmp/consul /usr/bin"

#NOTE: Upgrade pip to latest which is useful for installation of packages like docker-compose
- name: upgrade pip
  pip:
    name: pip
    extra_args: "--upgrade"

#- name: setup systemd files for services
#  copy: src=files/{{ item }} dest=/etc/default/{{ item }}
#  with_items:
#    - consul
#- name: setup systemd units for services
#  copy: src=files/{{ item }}.service dest=/etc/systemd/system/{{ item }}.service
#  with_items:
#    - volmaster 
#    - volplugin
#    - consul
# - name: start the services
#   shell: systemctl daemon-reload
